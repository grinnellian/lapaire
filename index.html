<h1> Lapaire RX Validation Form</h1>
<form>
  <div>
    <label for="customerNumber">Customer #:</label>
    <input type="tel" name="customerNumber" id="customerNumber" pattern="\+?[\d\- ]{6,}" title="Must be customer's telephone number. Six digits or more."> <br />
  </div>
  <div>
    <label>DP:
      <input type="number" name="DP" id="DP" min=60 max=80 step=2 value=70 />
    </label>
    <div id="DP_val"></div>
  </div>
  <h2>OD</h2>
  <div>
    <label>SPH:
      <input type="number" name="sph-od" id="sph-od" min=-20 max=20 step=0.25 value=0 />
      <div id="sph-od_val"></div>
    </label>
  </div>

  <div>
    <label>CYL:
      <input type="number" name="cyl-od" id="cyl-od" min=-10 max=0 step=0.25 value=0 />
      <div id="cyl-od_val"></div>
    </label>
  </div>

  <div>
    <label>AXE:
      <input type="number" name="axe-od" id="axe-od" min=1 max=180 disabled=true title="Between 0 and 180 when CYL is filled" />
      <div id="axe-od_val"></div>
    </label>
  </div>

  <div>
    <label>ADD:
      <input type="number" name="add-od" id="add-od" min=0 max=4 step=0.25 value=0 />
      <div id="add-od_val"></div>
    </label>
  </div>

  <h2>OG</h2>
  <div>
    <label>SPH:
      <input type="number" name="sph-og" id="sph-og" min=-20 max=20 step=0.25 value=0 />
      <div id="sph-og_val"></div>
    </label>
  </div>
  <div>
    <label>CYL:
      <input type="number" name="cyl-og" id="cyl-og" min=-10 max=0 step=0.25 value=0 />
      <div id="cyl-og_val"></div>
    </label>
  </div>

  <div>
    <label>AXE:
      <input type="number" name="axe-og" id="axe-og" min=1 max=180 disabled=true title="Between 0 and 180 when CYL is filled" />
      <div id="axe-og_val"></div>
    </label>
  </div>

  <div>
    <label>ADD:
      <input type="number" name="add-og" id="add-og" min=0 max=4 step=0.25 value=0 />
      <div id="add-og_val"></div>
    </label>
  </div>

  <div>
    <button>Submit</button>
  </div>
</form>	

<script>
  const DPVal = function(event) {
    const elem = document.getElementById("DP");
    const dp = Number.parseInt(elem.value);
    console.log("parse dp: " + dp);
    if (!(dp <= 80 && dp >= 60) ||
    dp % 2 != 0) {
      // alert("DP must be even and between 60 & 80");
      document.getElementById("DP_val").textContent = "(Must be even, 60-80)"
    } else {
      document.getElementById("DP_val").textContent = "Looks good!"
    }
  }

document.getElementById("DP").addEventListener("change", DPVal);

const sphVal = function(oleil) {
  return function(event) {
    const elem = document.getElementById(`sph-${oleil}`);
    const sph = Number.parseFloat(elem.value);
    console.log("parse sph: " + sph);
    const resultId = `sph-${oleil}_val`;
    console.log("result div: " + resultId)
    const res = document.getElementById(resultId);
    if (!(sph <= 20 && sph >= -20)) {
      res.textContent = "Must be between -20 and +20"
    } else if ((sph % 0.25) != 0) {
      res.textContent = "Must be in increments of 0.25"
    } else {
      res.textContent = "Looks good!"
    }
  }
}

document.getElementById("sph-od").addEventListener("change", sphVal("od"));
document.getElementById("sph-og").addEventListener("change", sphVal("og"));

const validatorListenerFactory = function(field, validator) {
  return function(event) {
    const elem = document.getElementById(field);
    const val = Number.parseFloat(elem.value);
    console.log(`Parsed ${field}: ${val}`)
    const res = document.getElementById(`${field}_val`)
    if (!res) { alert(`Validation output field missing: ${field}`)};
    res.textContent = (validator(val) || "Looks good!")
  }
}

const attachSymmetricFieldValidators = function(field, validator) {
  for (const oeil of ["od", "og"]) {
    document.getElementById(`${field}-${oeil}`).addEventListener("change", validatorListenerFactory(`${field}-${oeil}`, validator));
  }
}

const cylValidator = function(cyl) {
  if (!(cyl <= 0 && cyl >= -10)) {
    return "Must be between 0 and -10."
  } else if ((cyl % 0.25) != 0) {
    return "Must be in increments of 0.25."
  }
  return null;
}

attachSymmetricFieldValidators("cyl", cylValidator);

const axeValidator = function(axe) {
  if (!(axe >= 1 && axe <= 180)) {
    return "Must be between 1 and 180."
  } else if (axe != Number.parseInt(axe)) {
    return "Must be an integer.";
  }
  return null;
}

attachSymmetricFieldValidators("axe", axeValidator);

// override will override any value currently in the target field, or leave current value if unspecified
const attachFieldDependency = function (source, listener, enabledCondition, enabledRequired=true) {
  for (const oeil of ["od", "og"]) {
    const src = document.getElementById(`${source}-${oeil}`) || alert("missing dependency source " + `${source}-${oeil}`);
    const lstnr = document.getElementById(`${listener}-${oeil}`) || alert("missing dependent field " + `${listener}-${oeil}`);
    src.addEventListener("change", (event) => {
      console.log(`src ${src.id}: ${src.value}`);
      if (!enabledCondition(src.value)) {
        lstnr.disabled = true;
        lstnr.value = null;
        document.getElementById(`${listener}-${oeil}_val`).textContent = "";
      } else {
        lstnr.disabled = false;
        lstnr.required = enabledRequired;
      }
    });
  }
}

attachFieldDependency("cyl", "axe", (cyl) => {return cyl < 0 && cyl >= -10});

const addValidator = function(add) {
  if(add != 0) {
    if (!(1 <= add && 4 >= add)) {
      return "If selected, between 1 and 4.";
    } else if ((add % 0.25) != 0) {
      return "Increments of 0.25";
    }
  }
}

attachSymmetricFieldValidators("add", addValidator);

document.getElementById("add-od").addEventListener("change", () => {
  document.getElementById("add-og").value = document.getElementById("add-od").value;
});

document.getElementById("add-og").addEventListener("change", () => {
  document.getElementById("add-og").value = document.getElementById("add-od").value;
});

var urlParams = new URLSearchParams(window.location.search);
console.log(urlParams.toString())
if (urlParams.has("customerNumber")) {
  document.getElementById("customerNumber").value = urlParams.get("customerNumber")
}

  // const addInputListeners = function() {
  //   alert("Input listeners!");
  // }

  // document.addEventListener('readystatechange', (event) => {
  //   console.log("readystatechange: " + JSON.stringify(event));
  //   switch(event) {
  //     case "interactive":
  //     case "complete":
  //       addInputListeners();
  //       break;
  //   }
  // });
</script>