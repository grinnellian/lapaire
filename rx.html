<h1> Lapaire RX Validation Form</h1>
<form>
  <div>
    <label for="customerNumber">Customer #:</label>
    <input type="tel" name="customerNumber" id="customerNumber" pattern="\+?[\d\- ]{6,}" title="Must be customer's telephone number."> <br />
  </div>
  <div>
    <label>DP:
      <input type="number" name="DP" id="DP">
    </label>
    <div id="DP_val"></div>
  </div>
  <h2>OD</h2>
  <div>
    <label>SPH:
      <input type="number" name="sph-od" id="sph-od" />
      <div id="sph-od_val"></div>
    </label>
  </div>

  <div>
    <label>CYL:
      <input type="number" name="cyl-od" id="cyl-od" />
      <div id="cyl-od_val"></div>
    </label>
  </div>

  <h2>OG</h2>
  <div>
    <label>SPH:
      <input type="number" name="sph-og" id="sph-og" />
      <div id="sph-og_val"></div>
    </label>
  </div>
  <div>
    <label>CYL:
      <input type="number" name="cyl-og" id="cyl-og" />
      <div id="cyl-og_val"></div>
    </label>
  </div>

  <div>
    <button>Submit</button>
  </div>
</form>	

<script>
  const DPVal = function(event) {
    const elem = document.getElementById("DP");
    const dp = Number.parseInt(elem.value);
    console.log("parse dp: " + dp);
    if (!(dp <= 80 && dp >= 60) ||
    dp % 2 != 0) {
      // alert("DP must be even and between 60 & 80");
      document.getElementById("DP_val").textContent = "(Must be even, 60-80)"
    } else {
      document.getElementById("DP_val").textContent = "Looks good!"
    }
  }

document.getElementById("DP").addEventListener("change", DPVal);

const sphVal = function(oleil) {
  return function(event) {
    const elem = document.getElementById(`sph-${oleil}`);
    const sph = Number.parseFloat(elem.value);
    console.log("parse sph: " + sph);
    const resultId = `sph-${oleil}_val`;
    console.log("result div: " + resultId)
    const res = document.getElementById(resultId);
    if (!(sph <= 20 && sph >= -20)) {
      res.textContent = "Must be between -20 and +20"
    } else if ((sph % 0.25) != 0) {
      res.textContent = "Must be in increments of 0.25"
    } else {
      res.textContent = "Looks good!"
    }
  }
}

document.getElementById("sph-od").addEventListener("change", sphVal("od"));
document.getElementById("sph-og").addEventListener("change", sphVal("og"));

const validatorListenerFactory = function(field, validator) {
  return function(event) {
    const elem = document.getElementById(field);
    const val = Number.parseFloat(elem.value);
    console.log(`Parsed ${field}: ${val}`)
    const res = document.getElementById(`${field}_val`)
    if (!res) { alert(`Validation output field missing: ${field}`)};
    res.textContent = (validator(val) || "Looks good!")
  }
}

const attachSymmetricFieldValidators = function(field, validator) {
  document.getElementById(`${field}-od`).addEventListener("change", validatorListenerFactory(`${field}-od`, validator));
  document.getElementById(`${field}-og`).addEventListener("change", validatorListenerFactory(`${field}-og`, validator));
}

const cylValidator = function(cyl) {
  let res = null;
  if (!(cyl <= 0 && cyl >= -10)) {
    res = "Must be between 0 and -10."
  } else if ((cyl % 0.25) != 0) {
    res = "Must be in increments of 0.25."
  }
  return res;
}

attachSymmetricFieldValidators("cyl", cylValidator);

  var urlParams = new URLSearchParams(window.location.search);
  console.log(urlParams.toString())
  if (urlParams.has("customerNumber")) {
    document.getElementById("customerNumber").value = urlParams.get("customerNumber")
  }

  // const addInputListeners = function() {
  //   alert("Input listeners!");
  // }

  // document.addEventListener('readystatechange', (event) => {
  //   console.log("readystatechange: " + JSON.stringify(event));
  //   switch(event) {
  //     case "interactive":
  //     case "complete":
  //       addInputListeners();
  //       break;
  //   }
  // });
</script>